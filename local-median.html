<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Median Approach - EPA Local Median Smoothing</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        .math-box {
            background: linear-gradient(135deg, #f5f7ff 0%, #fff 100%);
            border: 2px solid #667eea;
            border-radius: 6px;
            padding: 0.5rem;
            margin: 0.5rem 0;
        }
        .math-box h4 {
            color: #667eea;
            margin-bottom: 0.3rem;
            font-size: 0.95rem;
        }
        .step-list {
            counter-reset: step-counter;
            list-style: none;
            padding: 0;
        }
        .step-list li {
            counter-increment: step-counter;
            padding: 0.4rem 0.5rem 0.4rem 2.5rem;
            margin: 0.25rem 0;
            background: #f8f9fa;
            border-radius: 4px;
            position: relative;
            font-size: 0.85rem;
        }
        .step-list li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.75rem;
        }
        .algorithm-box {
            background: #2d2d2d;
            border-radius: 6px;
            padding: 0.5rem;
            margin: 0.5rem 0;
            color: #f8f8f2;
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
        }
        .algorithm-box h4 {
            color: #667eea;
            margin-bottom: 0.3rem;
            font-family: 'Segoe UI', sans-serif;
            font-size: 0.9rem;
        }
        .algorithm-line {
            margin: 0.15rem 0;
            padding-left: 0.5rem;
        }
        .keyword {
            color: #ff79c6;
        }
        .comment {
            color: #6272a4;
        }
        .var {
            color: #50fa7b;
        }
        .param-table {
            margin: 0.5rem 0;
        }
        .param-table th {
            background: #667eea;
        }
        .bandwidth-visual {
            background: white;
            border-radius: 6px;
            padding: 0.5rem;
            margin: 0.5rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .bandwidth-bar {
            display: flex;
            align-items: center;
            margin: 0.3rem 0;
        }
        .bandwidth-label {
            width: 50px;
            font-weight: bold;
            color: #667eea;
            font-size: 0.85rem;
        }
        .bandwidth-track {
            flex: 1;
            height: 18px;
            background: #f0f0f0;
            border-radius: 3px;
            position: relative;
            margin: 0 0.5rem;
        }
        .bandwidth-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            transition: width 0.3s;
        }
        .bandwidth-value {
            width: 50px;
            text-align: right;
            font-family: monospace;
            color: #333;
            font-size: 0.8rem;
        }
        .highlight-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 0.4rem 0.6rem;
            margin: 0.4rem 0;
            font-size: 0.85rem;
        }
        .highlight-box strong {
            color: #856404;
        }
        /* Interactive Demo Styles */
        .viz-tabs {
            display: flex;
            gap: 0.25rem;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 0.5rem;
        }
        .viz-tab {
            padding: 0.4rem 0.8rem;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 4px 4px 0 0;
            transition: all 0.2s;
        }
        .viz-tab:hover {
            background: #e0e0e0;
        }
        .viz-tab.active {
            background: #667eea;
            color: white;
        }
        .viz-content {
            display: none;
        }
        .viz-content.active {
            display: block;
        }
        .viz-chart {
            width: 100%;
            height: 300px;
        }
        .control-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.4rem 0;
            flex-wrap: wrap;
        }
        .control-row label {
            font-weight: 500;
            font-size: 0.85rem;
            min-width: 80px;
        }
        .control-row input[type="range"] {
            flex: 1;
            min-width: 150px;
        }
        .control-row .value-display {
            font-family: monospace;
            background: #f0f0f0;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.8rem;
            min-width: 50px;
            text-align: center;
        }
        .outlier-btns {
            display: flex;
            gap: 0.25rem;
        }
        .outlier-btn {
            padding: 0.3rem 0.6rem;
            border: 1px solid #667eea;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            border-radius: 3px;
            transition: all 0.2s;
        }
        .outlier-btn:hover {
            background: #f0f0ff;
        }
        .outlier-btn.active {
            background: #667eea;
            color: white;
        }
        .mse-panel {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.4rem;
        }
        .mse-card {
            flex: 1;
            padding: 0.4rem;
            border-radius: 4px;
            text-align: center;
        }
        .mse-card.median {
            background: #e8f5e9;
            border: 1px solid #4caf50;
        }
        .mse-card.mean {
            background: #ffebee;
            border: 1px solid #f44336;
        }
        .mse-card .label {
            font-size: 0.75rem;
            color: #666;
        }
        .mse-card .value {
            font-size: 1rem;
            font-weight: bold;
        }
        .mse-card.median .value { color: #2e7d32; }
        .mse-card.mean .value { color: #c62828; }
        .calc-panel {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 0.4rem;
            margin-top: 0.4rem;
            font-size: 0.8rem;
            max-height: 150px;
            overflow-y: auto;
        }
        .calc-panel h5 {
            margin-bottom: 0.3rem;
            color: #667eea;
        }
        .calc-table {
            width: 100%;
            font-size: 0.75rem;
        }
        .calc-table th {
            background: #667eea;
            color: white;
            padding: 2px 4px;
        }
        .calc-table td {
            padding: 2px 4px;
            text-align: center;
        }
        .calc-table tr.median-row {
            background: #e8f5e9;
            font-weight: bold;
        }
        .click-hint {
            color: #666;
            font-style: italic;
            font-size: 0.8rem;
            text-align: center;
            margin-bottom: 0.3rem;
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-container">
        <a href="index.html" class="nav-logo">EPA Smoothing</a>
        <button class="nav-toggle" onclick="toggleNav()">&#9776;</button>
        <ul class="nav-menu" id="nav-menu">
            <li><a href="index.html">Home</a></li>
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="theory.html">Theory</a></li>
            <li><a href="emd-intro.html">EMD Intro</a></li>
            <li><a href="local-median.html">Local Median</a></li>
            <li><a href="sifting.html">Sifting</a></li>
            <li><a href="api.html">API</a></li>
            <li><a href="code.html">Code</a></li>
            <li><a href="examples.html">Examples</a></li>
            <li><a href="team.html">Team</a></li>
        </ul>
    </div>
</nav>

    <section class="hero">
        <h1>Local Median Approach</h1>
        <p>Mathematical formulation and iterative procedure for robust EMD</p>
    </section>

    <div class="container">
        <div class="section">
            <h2>Mathematical Setup</h2>
            <p>The local median approach replaces the standard weighted mean with a weighted median, providing robustness against outliers while preserving the adaptive nature of kernel smoothing.</p>

            <div class="math-box">
                <h4>Core Optimization Problem</h4>
                <p>At each point \(t\), we find the local median as the solution to a weighted L1 minimization:</p>
                <div class="formula">
                    \[ \tilde{X}_t^{(1)} = \underset{m}{\text{argmin}} \sum_s |X_s - m| \cdot K_h(s-t) \]
                </div>
                <p style="margin-top: 0.5rem; color: #666;">This is exactly the <strong>weighted median</strong> of the observations \(\{X_s\}\) with weights \(\{K_h(s-t)\}\).</p>
            </div>

            <h3>Kernel Function</h3>
            <p>We use the Epanechnikov kernel with bandwidth \(h\):</p>

            <div class="formula">
                \[ K_h(u) = \frac{1}{h} K\left(\frac{u}{h}\right) \]
            </div>

            <div class="formula">
                \[ K(u) = \frac{3}{4}(1 - u^2) \cdot \mathbf{1}_{|u| \leq 1} \]
            </div>

            <h3>Why Weighted Median?</h3>
            <table>
                <tr>
                    <th>Property</th>
                    <th>Weighted Mean</th>
                    <th>Weighted Median</th>
                </tr>
                <tr>
                    <td>Optimization</td>
                    <td>\(\min_m \sum w_i(y_i - m)^2\)</td>
                    <td>\(\min_m \sum w_i|y_i - m|\)</td>
                </tr>
                <tr>
                    <td>Breakdown Point</td>
                    <td class="highlight-red">0%</td>
                    <td class="highlight-green">50%</td>
                </tr>
                <tr>
                    <td>Single Outlier Effect</td>
                    <td>Unbounded influence</td>
                    <td>Bounded influence</td>
                </tr>
                <tr>
                    <td>Computation</td>
                    <td>Simple average</td>
                    <td>Requires sorting</td>
                </tr>
            </table>
        </div>

        <div class="section">
            <h2>Interactive Demonstration</h2>
            <p>Explore the local median approach with these interactive visualizations.</p>

            <div class="viz-tabs">
                <button class="viz-tab active" onclick="showViz('point')">Point Demo</button>
                <button class="viz-tab" onclick="showViz('bandwidth')">Bandwidth</button>
                <button class="viz-tab" onclick="showViz('comparison')">Comparison</button>
            </div>

            <div id="viz-point" class="viz-content active">
                <p class="click-hint">Click anywhere on the chart to see the weighted median calculation at that point</p>
                <div id="point-chart" class="viz-chart"></div>
                <div class="control-row">
                    <label>Bandwidth h:</label>
                    <input type="range" id="point-h-slider" min="0.3" max="1.5" step="0.1" value="0.8">
                    <span id="point-h-value" class="value-display">0.80</span>
                </div>
                <div id="calc-panel" class="calc-panel" style="display:none;">
                    <h5>Weighted Median Calculation at t = <span id="calc-t">-</span></h5>
                    <table class="calc-table">
                        <thead><tr><th>y<sub>i</sub></th><th>w<sub>i</sub></th><th>Cum. W</th></tr></thead>
                        <tbody id="calc-tbody"></tbody>
                    </table>
                    <p style="margin-top:0.3rem;">Weighted Median = <strong id="calc-result">-</strong></p>
                </div>
            </div>

            <div id="viz-bandwidth" class="viz-content">
                <div id="bandwidth-chart" class="viz-chart"></div>
                <div class="control-row">
                    <label>Bandwidth h:</label>
                    <input type="range" id="bw-slider" min="0.1" max="1.5" step="0.05" value="0.5">
                    <span id="bw-value" class="value-display">0.50</span>
                    <button class="outlier-btn" onclick="animateBandwidth()">Animate</button>
                </div>
                <div class="mse-panel">
                    <div class="mse-card median">
                        <div class="label">MSE (Local Median)</div>
                        <div class="value" id="bw-mse">-</div>
                    </div>
                </div>
            </div>

            <div id="viz-comparison" class="viz-content">
                <div id="comparison-chart" class="viz-chart"></div>
                <div class="control-row">
                    <label>Outliers:</label>
                    <div class="outlier-btns">
                        <button class="outlier-btn active" onclick="setOutliers(0)">0%</button>
                        <button class="outlier-btn" onclick="setOutliers(0.05)">5%</button>
                        <button class="outlier-btn" onclick="setOutliers(0.1)">10%</button>
                        <button class="outlier-btn" onclick="setOutliers(0.2)">20%</button>
                    </div>
                </div>
                <div class="mse-panel">
                    <div class="mse-card median">
                        <div class="label">MSE (Local Median)</div>
                        <div class="value" id="cmp-mse-median">-</div>
                    </div>
                    <div class="mse-card mean">
                        <div class="label">MSE (Local Mean)</div>
                        <div class="value" id="cmp-mse-mean">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Iterative Sifting Procedure</h2>
            <p>The local median smoothing is applied iteratively with decreasing bandwidth to extract multiple IMFs.</p>

            <div class="math-box">
                <h4>Sifting Step k</h4>
                <div class="formula">
                    \[ \tilde{X}_t^{(k)} = \underset{m}{\text{argmin}} \sum_s |X_s^{(k)} - m| \cdot K_{h_k}(s-t) \]
                </div>
                <p style="margin-top: 0.5rem;">Valid for \(t \in [h_k, 1-h_k]\) (boundary handling).</p>
            </div>

            <div class="math-box">
                <h4>Residual Update</h4>
                <div class="formula">
                    \[ X_t^{(k+1)} = X_t^{(k)} - \tilde{X}_t^{(k)} \]
                </div>
                <p style="margin-top: 0.5rem;">The residual from iteration \(k\) becomes the input for iteration \(k+1\).</p>
            </div>

            <h3>Algorithm Steps</h3>
            <ol class="step-list">
                <li><strong>Initialize:</strong> Set \(X^{(1)} = X\) (original signal) and choose initial bandwidth \(h_1\)</li>
                <li><strong>Smooth:</strong> Compute local median \(\tilde{X}^{(k)}\) using bandwidth \(h_k\)</li>
                <li><strong>Extract:</strong> Store \(\tilde{X}^{(k)}\) as the k-th IMF component</li>
                <li><strong>Residual:</strong> Compute \(X^{(k+1)} = X^{(k)} - \tilde{X}^{(k)}\)</li>
                <li><strong>Halve:</strong> Update bandwidth \(h_{k+1} = h_k / \sqrt{2}\)</li>
                <li><strong>Check:</strong> If \(h_{k+1} < h_{\min}\), stop. Otherwise, repeat from step 2</li>
            </ol>
        </div>

        <div class="section">
            <h2>Bandwidth Selection</h2>
            <p>The bandwidth sequence controls the scale of features extracted at each iteration.</p>

            <div class="math-box">
                <h4>Geometric Decay Rule</h4>
                <div class="formula">
                    \[ h_{k+1} = \frac{h_k}{\sqrt{2}}, \quad k = 1, 2, \ldots \]
                </div>
                <p style="margin-top: 0.5rem;">Equivalently: \(h_k = h_1 \cdot 2^{-(k-1)/2}\)</p>
            </div>

            <h3>Initialization</h3>
            <div class="highlight-box">
                <strong>Rule of thumb:</strong> Start with \(h_1 \approx 0.1\) to smooth out noise while capturing gross features of the signal.
            </div>

            <h3>Stopping Criterion</h3>
            <div class="highlight-box">
                <strong>Stop when:</strong> \(h_{k+1} < h_{\min}\), where \(h_{\min}\) is the minimum meaningful bandwidth (typically around 0.02-0.03 depending on sample size).
            </div>

            <h3>Bandwidth Sequence Visualization</h3>
            <div class="bandwidth-visual">
                <div class="bandwidth-bar">
                    <span class="bandwidth-label">h1</span>
                    <div class="bandwidth-track">
                        <div class="bandwidth-fill" style="width: 100%;"></div>
                    </div>
                    <span class="bandwidth-value">0.1000</span>
                </div>
                <div class="bandwidth-bar">
                    <span class="bandwidth-label">h2</span>
                    <div class="bandwidth-track">
                        <div class="bandwidth-fill" style="width: 70.7%;"></div>
                    </div>
                    <span class="bandwidth-value">0.0707</span>
                </div>
                <div class="bandwidth-bar">
                    <span class="bandwidth-label">h3</span>
                    <div class="bandwidth-track">
                        <div class="bandwidth-fill" style="width: 50%;"></div>
                    </div>
                    <span class="bandwidth-value">0.0500</span>
                </div>
                <div class="bandwidth-bar">
                    <span class="bandwidth-label">h4</span>
                    <div class="bandwidth-track">
                        <div class="bandwidth-fill" style="width: 35.4%;"></div>
                    </div>
                    <span class="bandwidth-value">0.0354</span>
                </div>
                <div class="bandwidth-bar">
                    <span class="bandwidth-label">h5</span>
                    <div class="bandwidth-track">
                        <div class="bandwidth-fill" style="width: 25%;"></div>
                    </div>
                    <span class="bandwidth-value">0.0250</span>
                </div>
            </div>

            <table class="param-table">
                <tr>
                    <th>Iteration</th>
                    <th>Bandwidth</th>
                    <th>Formula</th>
                    <th>Captures</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>0.1</td>
                    <td>\(h_1\)</td>
                    <td>Gross trend / low frequency</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>0.0707</td>
                    <td>\(h_1/\sqrt{2}\)</td>
                    <td>Medium-scale features</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>0.05</td>
                    <td>\(h_1/2\)</td>
                    <td>Finer oscillations</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>0.0354</td>
                    <td>\(h_1/(2\sqrt{2})\)</td>
                    <td>High frequency details</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>0.025</td>
                    <td>\(h_1/4\)</td>
                    <td>Finest resolvable scale</td>
                </tr>
            </table>
        </div>

        <div class="section">
            <h2>Output: IMF Collection</h2>
            <p>The sifting process produces a sequence of Intrinsic Mode Functions.</p>

            <div class="math-box">
                <h4>IMF Sequence</h4>
                <div class="formula">
                    \[ \text{IMFs} = \left\{ \tilde{X}_t^{(1)}, \tilde{X}_t^{(2)}, \ldots, \tilde{X}_t^{(K)} \right\} \]
                </div>
                <p style="margin-top: 0.5rem;">where \(K\) is determined by the stopping criterion.</p>
            </div>

            <div class="math-box">
                <h4>Signal Reconstruction</h4>
                <div class="formula">
                    \[ \bar{X}_t = \sum_{k=1}^{K} \tilde{X}_t^{(k)} \]
                </div>
                <p style="margin-top: 0.5rem;">The sum of all IMFs approximates the original signal (minus the final residual).</p>
            </div>

            <h3>Properties of the Decomposition</h3>
            <ul style="margin-left: 2rem;">
                <li><strong>Multi-scale:</strong> Each IMF captures oscillations at a characteristic scale</li>
                <li><strong>Adaptive:</strong> Scales are determined by the data, not predetermined</li>
                <li><strong>Robust:</strong> Outliers have limited influence on the decomposition</li>
                <li><strong>Complete:</strong> All signal components are captured in the IMF collection</li>
            </ul>
        </div>

        <div class="section">
            <h2>Pseudocode</h2>
            <div class="algorithm-box">
                <h4>Local Median EMD Sifting</h4>
                <div class="algorithm-line"><span class="keyword">function</span> <span class="var">emd_local_median</span>(X, h_init, h_min):</div>
                <div class="algorithm-line" style="padding-left: 2rem;">IMFs = []</div>
                <div class="algorithm-line" style="padding-left: 2rem;">residual = X</div>
                <div class="algorithm-line" style="padding-left: 2rem;">h = h_init</div>
                <div class="algorithm-line" style="padding-left: 2rem;"></div>
                <div class="algorithm-line" style="padding-left: 2rem;"><span class="keyword">while</span> h >= h_min:</div>
                <div class="algorithm-line" style="padding-left: 3rem;"><span class="comment"># Compute local median with bandwidth h</span></div>
                <div class="algorithm-line" style="padding-left: 3rem;">trend = local_median_smooth(residual, h)</div>
                <div class="algorithm-line" style="padding-left: 3rem;"></div>
                <div class="algorithm-line" style="padding-left: 3rem;"><span class="comment"># Store as IMF</span></div>
                <div class="algorithm-line" style="padding-left: 3rem;">IMFs.append(trend)</div>
                <div class="algorithm-line" style="padding-left: 3rem;"></div>
                <div class="algorithm-line" style="padding-left: 3rem;"><span class="comment"># Update residual</span></div>
                <div class="algorithm-line" style="padding-left: 3rem;">residual = residual - trend</div>
                <div class="algorithm-line" style="padding-left: 3rem;"></div>
                <div class="algorithm-line" style="padding-left: 3rem;"><span class="comment"># Halve bandwidth</span></div>
                <div class="algorithm-line" style="padding-left: 3rem;">h = h / sqrt(2)</div>
                <div class="algorithm-line" style="padding-left: 2rem;"></div>
                <div class="algorithm-line" style="padding-left: 2rem;"><span class="keyword">return</span> IMFs, residual</div>
            </div>
        </div>

        <div class="section">
            <h2>Next: See Results</h2>
            <div class="nav-cards">
                <a href="sifting.html" class="nav-card">
                    <h4>Sifting Process</h4>
                    <p>Visualizations of iterations 1-5 with charts</p>
                </a>
                <a href="dashboard.html" class="nav-card">
                    <h4>Interactive Dashboard</h4>
                    <p>Try the smoother with adjustable parameters</p>
                </a>
                <a href="theory.html" class="nav-card">
                    <h4>Mathematical Theory</h4>
                    <p>Kernel functions and weighted median details</p>
                </a>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>EPA Local Median Smoothing | <a href="https://github.com/Digital-AI-Finance/epa_smoothing">GitHub</a></p>
    </footer>

    <script>
        function toggleNav() {
            document.getElementById('nav-menu').classList.toggle('active');
        }

        // ============================================
        // Core Algorithm Functions
        // ============================================

        function epanechnikov(u) {
            return Math.abs(u) <= 1 ? 0.75 * (1 - u * u) : 0;
        }

        function weightedMedian(values, weights) {
            if (values.length === 0) return NaN;
            const pairs = values.map((v, i) => ({ v, w: weights[i] }))
                .filter(p => p.w > 0)
                .sort((a, b) => a.v - b.v);
            if (pairs.length === 0) return NaN;
            const totalW = pairs.reduce((s, p) => s + p.w, 0);
            let cumW = 0;
            for (let i = 0; i < pairs.length; i++) {
                cumW += pairs[i].w / totalW;
                if (cumW >= 0.5) return pairs[i].v;
            }
            return pairs[pairs.length - 1].v;
        }

        function localMedian(x, y, h) {
            return x.map((xi) => {
                const weights = x.map(xj => epanechnikov((xj - xi) / h));
                return weightedMedian(y, weights);
            });
        }

        function localMean(x, y, h) {
            return x.map((xi) => {
                const weights = x.map(xj => epanechnikov((xj - xi) / h));
                const sumW = weights.reduce((s, w) => s + w, 0);
                if (sumW === 0) return NaN;
                const sumWY = weights.reduce((s, w, i) => s + w * y[i], 0);
                return sumWY / sumW;
            });
        }

        function mse(predicted, actual) {
            const valid = predicted.map((p, i) => [p, actual[i]]).filter(([p, a]) => !isNaN(p) && !isNaN(a));
            if (valid.length === 0) return NaN;
            return valid.reduce((s, [p, a]) => s + (p - a) ** 2, 0) / valid.length;
        }

        // ============================================
        // Data Generation
        // ============================================

        const N = 100;
        const xData = Array.from({ length: N }, (_, i) => i * 2 * Math.PI / (N - 1));
        const trueSignal = xData.map(x => Math.sin(x) + 0.5 * Math.cos(2 * x));
        const noise = 0.25;
        let currentOutlierFrac = 0;
        let yData, yDataNoisy;

        function seededRandom(seed) {
            return function() {
                seed = (seed * 1103515245 + 12345) & 0x7fffffff;
                return seed / 0x7fffffff;
            };
        }

        function generateNoisyData(outlierFrac) {
            const rng = seededRandom(42);
            yDataNoisy = trueSignal.map((y, i) => {
                let val = y + (rng() - 0.5) * 2 * noise;
                if (rng() < outlierFrac) {
                    val += (rng() > 0.5 ? 1 : -1) * 2;
                }
                return val;
            });
            yData = [...yDataNoisy];
        }

        generateNoisyData(0);

        // ============================================
        // Tab Switching
        // ============================================

        function showViz(vizId) {
            document.querySelectorAll('.viz-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.viz-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[onclick="showViz('${vizId}')"]`).classList.add('active');
            document.getElementById('viz-' + vizId).classList.add('active');
            if (vizId === 'point') initPointDemo();
            else if (vizId === 'bandwidth') initBandwidthDemo();
            else if (vizId === 'comparison') initComparisonDemo();
        }

        // ============================================
        // Point Demo
        // ============================================

        let pointH = 0.8;

        function initPointDemo() {
            const trace1 = { x: xData, y: yData, mode: 'markers', type: 'scatter', name: 'Data', marker: { size: 6, color: '#999' } };
            const trace2 = { x: xData, y: trueSignal, mode: 'lines', type: 'scatter', name: 'True', line: { color: '#667eea', dash: 'dash', width: 2 } };
            const layout = { margin: { t: 20, r: 20, b: 40, l: 50 }, xaxis: { title: 'x' }, yaxis: { title: 'y' }, legend: { x: 0, y: 1 }, hovermode: 'closest' };
            Plotly.newPlot('point-chart', [trace1, trace2], layout, { responsive: true });
            document.getElementById('point-chart').on('plotly_click', onPointClick);
            document.getElementById('point-h-slider').oninput = function() {
                pointH = parseFloat(this.value);
                document.getElementById('point-h-value').textContent = pointH.toFixed(2);
            };
        }

        function onPointClick(data) {
            const t0 = data.points[0].x;
            const h = pointH;
            const inWindow = xData.map((x, i) => ({ x, y: yData[i], i })).filter(p => Math.abs(p.x - t0) <= h);
            const weights = inWindow.map(p => epanechnikov((p.x - t0) / h));
            const totalW = weights.reduce((s, w) => s + w, 0);
            const sorted = inWindow.map((p, i) => ({ y: p.y, w: weights[i] })).sort((a, b) => a.y - b.y);
            let cumW = 0, medianIdx = 0;
            for (let i = 0; i < sorted.length; i++) {
                cumW += sorted[i].w / totalW;
                if (cumW >= 0.5) { medianIdx = i; break; }
            }
            const wMedian = sorted[medianIdx].y;

            // Update calc panel
            document.getElementById('calc-panel').style.display = 'block';
            document.getElementById('calc-t').textContent = t0.toFixed(2);
            document.getElementById('calc-result').textContent = wMedian.toFixed(4);
            const tbody = document.getElementById('calc-tbody');
            tbody.innerHTML = '';
            cumW = 0;
            sorted.forEach((p, i) => {
                cumW += p.w / totalW;
                const tr = document.createElement('tr');
                if (i === medianIdx) tr.className = 'median-row';
                tr.innerHTML = `<td>${p.y.toFixed(3)}</td><td>${(p.w / totalW).toFixed(3)}</td><td>${cumW.toFixed(3)}</td>`;
                tbody.appendChild(tr);
            });

            // Update chart with kernel window
            const kernelX = [], kernelY = [];
            for (let xx = t0 - h; xx <= t0 + h; xx += 0.01) {
                kernelX.push(xx);
                kernelY.push(-1.5 + epanechnikov((xx - t0) / h) * 0.5);
            }
            const sizes = inWindow.map((p, i) => 5 + weights[i] * 15);
            const trace1 = { x: xData, y: yData, mode: 'markers', type: 'scatter', name: 'Data', marker: { size: 6, color: '#ccc' } };
            const trace2 = { x: inWindow.map(p => p.x), y: inWindow.map(p => p.y), mode: 'markers', type: 'scatter', name: 'In Window', marker: { size: sizes, color: '#667eea' } };
            const trace3 = { x: [t0], y: [wMedian], mode: 'markers', type: 'scatter', name: 'Weighted Median', marker: { size: 14, color: '#2ca02c', symbol: 'diamond' } };
            const trace4 = { x: kernelX, y: kernelY, mode: 'lines', type: 'scatter', name: 'Kernel', fill: 'tozeroy', fillcolor: 'rgba(102,126,234,0.2)', line: { color: '#667eea' } };
            const layout = { margin: { t: 20, r: 20, b: 40, l: 50 }, xaxis: { title: 'x' }, yaxis: { title: 'y', range: [-2, 2] }, legend: { x: 0, y: 1 }, showlegend: true };
            Plotly.react('point-chart', [trace1, trace4, trace2, trace3], layout);
            document.getElementById('point-chart').on('plotly_click', onPointClick);
        }

        // ============================================
        // Bandwidth Demo
        // ============================================

        function initBandwidthDemo() {
            updateBandwidthChart();
            document.getElementById('bw-slider').oninput = function() {
                document.getElementById('bw-value').textContent = parseFloat(this.value).toFixed(2);
                updateBandwidthChart();
            };
        }

        function updateBandwidthChart() {
            const h = parseFloat(document.getElementById('bw-slider').value);
            const smoothed = localMedian(xData, yData, h);
            const trace1 = { x: xData, y: yData, mode: 'markers', type: 'scatter', name: 'Noisy', marker: { size: 5, color: '#999' } };
            const trace2 = { x: xData, y: smoothed, mode: 'lines', type: 'scatter', name: 'Local Median', line: { color: '#667eea', width: 2 } };
            const trace3 = { x: xData, y: trueSignal, mode: 'lines', type: 'scatter', name: 'True', line: { color: '#2ca02c', dash: 'dash', width: 2 } };
            const layout = { margin: { t: 20, r: 20, b: 40, l: 50 }, xaxis: { title: 'x' }, yaxis: { title: 'y' }, legend: { x: 0, y: 1 } };
            Plotly.react('bandwidth-chart', [trace1, trace2, trace3], layout);
            document.getElementById('bw-mse').textContent = mse(smoothed, trueSignal).toFixed(4);
        }

        function animateBandwidth() {
            const slider = document.getElementById('bw-slider');
            let h = 1.5;
            const interval = setInterval(() => {
                h -= 0.05;
                if (h < 0.1) { clearInterval(interval); return; }
                slider.value = h;
                document.getElementById('bw-value').textContent = h.toFixed(2);
                updateBandwidthChart();
            }, 100);
        }

        // ============================================
        // Comparison Demo
        // ============================================

        function initComparisonDemo() {
            updateComparisonChart();
        }

        function setOutliers(frac) {
            currentOutlierFrac = frac;
            document.querySelectorAll('.outlier-btns .outlier-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            generateNoisyData(frac);
            updateComparisonChart();
        }

        function updateComparisonChart() {
            const h = 0.5;
            const smoothedMedian = localMedian(xData, yData, h);
            const smoothedMean = localMean(xData, yData, h);
            const trace1 = { x: xData, y: yData, mode: 'markers', type: 'scatter', name: 'Noisy', marker: { size: 5, color: '#999' } };
            const trace2 = { x: xData, y: smoothedMedian, mode: 'lines', type: 'scatter', name: 'Local Median', line: { color: '#2ca02c', width: 2 } };
            const trace3 = { x: xData, y: smoothedMean, mode: 'lines', type: 'scatter', name: 'Local Mean', line: { color: '#d62728', width: 2 } };
            const trace4 = { x: xData, y: trueSignal, mode: 'lines', type: 'scatter', name: 'True', line: { color: '#1f77b4', dash: 'dash', width: 2 } };
            const layout = { margin: { t: 20, r: 20, b: 40, l: 50 }, xaxis: { title: 'x' }, yaxis: { title: 'y' }, legend: { x: 0, y: 1 } };
            Plotly.react('comparison-chart', [trace1, trace2, trace3, trace4], layout);
            document.getElementById('cmp-mse-median').textContent = mse(smoothedMedian, trueSignal).toFixed(4);
            document.getElementById('cmp-mse-mean').textContent = mse(smoothedMean, trueSignal).toFixed(4);
        }

        // Initialize first tab on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initPointDemo, 100);
        });
    </script>
</body>
</html>
